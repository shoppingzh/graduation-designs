C51 COMPILER V9.01   MAIN                                                                  03/18/2018 16:07:20 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\Outputs\main.obj
COMPILER INVOKED BY: D:\Dev\Keil\C51\BIN\C51.EXE ..\User\main.c BROWSE INCDIR(..\Hardware;..\User) DEBUG OBJECTEXTEND PR
                    -INT(.\main.lst) OBJECT(..\Outputs\main.obj)

line level    source

   1          #include "reg51.h"
   2          #include "adc.h"
   3          #include "uart.h"
   4          #include "lcd1602.h"
   5          #include "stdio.h"
   6          
   7          void delay(uchar);
   8          void display_vol(uchar, uchar);
   9          void display();
  10          
  11          sbit ADDA = P2^4;
  12          sbit ADDB = P2^5;
  13          sbit ADDC = P2^6;
  14          
  15          uchar rode;
  16          uchar vol;
  17          bit state = 0;
  18          bit changed = 0;
  19          
  20          /////////MAIN
  21          void main(){
  22   1              uchar temp;
  23   1              uart_init();
  24   1              lcd_simple_init();
  25   1              lcd_display_string(1, 1, "Waiting..");
  26   1              
  27   1              while(1){
  28   2                      //上位机才能改变该状态位，该位为1时，开始转换并显示
  29   2                      if(state){
  30   3                              temp = adc_transform();
  31   3                              if(temp != vol){
  32   4                                      vol = temp;
  33   4                                      display();
  34   4                              }
  35   3                              uart_send(vol);
  36   3                              delay(10);
  37   3                      }               
  38   2              }
  39   1      
  40   1      }
  41          
  42          //串口接收回调：接收上位机指令，选择开启的模拟通道（对应不同量程的电压测量）
  43          void uart_received(uchar cmd){
  44   1              if(cmd == 0x01){
  45   2                      ADDA = 0;
  46   2                      ADDB = 0;
  47   2                      ADDC = 0;
  48   2                      rode = 1;
  49   2                      state = 1;      
  50   2              }else if(cmd == 0x02){
  51   2                      ADDA = 1;
  52   2                      ADDB = 0;
  53   2                      ADDC = 0;
  54   2                      rode = 2;
C51 COMPILER V9.01   MAIN                                                                  03/18/2018 16:07:20 PAGE 2   

  55   2                      state = 1;      
  56   2              }else if(cmd == 0x03){
  57   2                      ADDA = 0;
  58   2                      ADDB = 1;
  59   2                      ADDC = 0;
  60   2                      rode = 3;
  61   2                      state = 1;
  62   2              }else if(cmd == 0x04){
  63   2                      ADDA = 1;
  64   2                      ADDB = 1;
  65   2                      ADDC = 0;
  66   2                      rode = 4;
  67   2                      state = 1;
  68   2              }       
  69   1      }
  70          
  71          //延时
  72          void delay(uchar t){
  73   1              uchar i, j, k;
  74   1              for(i=0;i<t;i++)
  75   1                      for(j=0;j<20;j++)
  76   1                              for(k=0;k<110;k++);
  77   1      }
  78          
  79          //显示对应电压
  80          void display_vol(uchar row, uchar col){
  81   1              char str[10];
  82   1              int v = vol;
  83   1              float range;
  84   1              //对应量程显示不同的电压值
  85   1              if(rode == 1){
  86   2                      range = 0.5f;   
  87   2              }else if(rode == 2){
  88   2                      range = 5.0f;           
  89   2              }else if(rode == 3){
  90   2                      range = 50.0f;          
  91   2              }else if(rode == 4){
  92   2                      range = 500.0f;         
  93   2              }
  94   1              sprintf(str, "%.2fV", (v / 255.0 * range));             
  95   1              lcd_display_string(row, col, str);      
  96   1      }
  97          
  98          //显示
  99          void display(){
 100   1              char* str;
 101   1              lcd_clear();
 102   1              lcd_display_string(1, 1, "Range: ");
 103   1              if(rode == 1){
 104   2                      str = "(0-0.5V)";
 105   2              }else if(rode == 2){
 106   2                      str = "(0-5V)";
 107   2              }else if(rode == 3){
 108   2                      str = "(0-50V)";
 109   2              }else if(rode == 4){
 110   2                      str = "(0-500V)";
 111   2              }else{
 112   2                      str = "";
 113   2              }
 114   1              lcd_display_string(1, 8, str);
 115   1              lcd_display_string(2, 1, "VOL: ");
 116   1              display_vol(2, 6);
C51 COMPILER V9.01   MAIN                                                                  03/18/2018 16:07:20 PAGE 3   

 117   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    403    ----
   CONSTANT SIZE    =     64    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2      19
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
